================================================================================
RANKING SYSTEM - FELS√ñKNINGSDOKUMENTATION
================================================================================
Datum: 2025-11-24
Problem: Ranking-ber√§kning h√§nger p√• INSERT-queries
================================================================================

M√ÖL OCH KRAV
================================================================================

Implementera ett 24-m√•naders rullande rankingsystem f√∂r Enduro/Downhill med:

1. RANKINGBER√ÑKNING
   - 24 m√•naders rullande f√∂nster
   - Po√§ng viktade efter f√§ltstorlek (antal deltagare i klassen)
   - Event-niv√• viktning (nationell 100%, sportmotion 50%)
   - Tidsviktning (m√•nad 1-12: 100%, m√•nad 13-24: 50%)

2. RANKINGTYPER
   - √Ökar-ranking: Individuella po√§ng per √•kare
   - Klubb-ranking: Summerade po√§ng fr√•n klubbens √•kare
   - Uppdelat p√• discipliner: Enduro, DH, Gravity (kombinerat)

3. VIKTNINGSREGLER
   - F√§ltstorlek: 1 deltagare = 75%, 26+ deltagare = 100%
   - Event-niv√•: Nationell = 100%, Sportmotion = 50%
   - Tid: Senaste 12 m√•n = 100%, m√•nad 13-24 = 50%


VAD SOM IMPLEMENTERATS
================================================================================

DATABAS - MIGRATIONS
--------------------

1. 028_ranking_system.sql
   - Skapar ranking_points tabell
   - Skapar ranking_snapshots tabell (m√•natliga snapshots av ranking)
   - Skapar ranking_settings tabell (multiplikatorer och inst√§llningar)
   - L√§gger till event_level ENUM('national', 'sportmotion') p√• events

2. 029_club_ranking_system.sql
   - Skapar club_ranking_snapshots tabell

3. 030_fix_ranking_points_columns.sql
   - L√§gger till saknade kolumner discipline och event_level_multiplier
   - Dessa kolumner saknades trots att de fanns i CREATE TABLE i 028

RANKING_POINTS TABELL STRUKTUR
-------------------------------
CREATE TABLE `ranking_points` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `rider_id` int(11) NOT NULL,
  `event_id` int(11) NOT NULL,
  `class_id` int(11) NOT NULL,
  `discipline` VARCHAR(50) NOT NULL,
  `original_points` decimal(10,2) NOT NULL DEFAULT 0.00,
  `field_size` int(11) NOT NULL DEFAULT 1,
  `field_multiplier` decimal(5,4) NOT NULL DEFAULT 0.7500,
  `event_level_multiplier` DECIMAL(5,4) NOT NULL DEFAULT 1.0000,
  `ranking_points` decimal(10,2) NOT NULL DEFAULT 0.00,
  `event_date` date NOT NULL,
  `created_at` timestamp NULL DEFAULT current_timestamp(),
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_rider_event_class` (`rider_id`,`event_id`,`class_id`),
  KEY `idx_rider` (`rider_id`),
  KEY `idx_event_date` (`event_date`),
  KEY `idx_event_class` (`event_id`,`class_id`),
  KEY `idx_discipline` (`discipline`),
  KEY `class_id` (`class_id`),
  CONSTRAINT `ranking_points_ibfk_1` FOREIGN KEY (`rider_id`) REFERENCES `riders` (`id`) ON DELETE CASCADE,
  CONSTRAINT `ranking_points_ibfk_2` FOREIGN KEY (`event_id`) REFERENCES `events` (`id`) ON DELETE CASCADE,
  CONSTRAINT `ranking_points_ibfk_3` FOREIGN KEY (`class_id`) REFERENCES `classes` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci

PROBLEM: 5 index + 3 foreign keys = mycket overhead p√• varje INSERT!


KODFILER
--------

1. includes/ranking_functions.php
   Huvudfunktioner:
   - calculateAllRankingPoints($db, $debug = false)
   - createRankingSnapshot($db, $snapshotDate = null)
   - createClubRankingSnapshot($db, $snapshotDate = null)
   - getRankingEligibleResults($db, $cutoffDate = null)

   Ber√§kningsfl√∂de:
   1. H√§mta resultat fr√•n senaste 24 m√•naderna (WHERE e.date >= cutoffDate)
   2. Ber√§kna field sizes per event-class kombination (GROUP BY)
   3. Processa resultat i batchar om 50 √•t g√•ngen
   4. F√∂r varje resultat:
      - Ber√§kna field multiplier baserat p√• antal deltagare
      - Ber√§kna event level multiplier (national/sportmotion)
      - Ber√§kna ranking_points = original_points * field_mult * event_mult
   5. Samla 50 rader och g√∂r bulk INSERT IGNORE

2. admin/event-edit.php + admin/event-create.php
   - Lagt till dropdown f√∂r event_level (National/Sportmotion)
   - Sparas i events.event_level kolumn

3. ranking/index.php
   - Publik vy av ranking
   - Toggle mellan riders och clubs
   - Tabs f√∂r Enduro/DH/Gravity

4. admin/ranking.php
   - Admin-interface f√∂r att k√∂ra ber√§kning
   - Visa inst√§llningar och statistik
   - "K√∂r ber√§kning" knapp


PROBLEMET - BER√ÑKNINGEN H√ÑNGER
================================================================================

SYMPTOM
-------
N√§r calculateAllRankingPoints() k√∂rs:

1. ‚úÖ Cutoff date ber√§knas korrekt (2023-11-24)
2. ‚úÖ 1202 resultat hittas
3. ‚úÖ 108 event-class kombinationer hittas
4. ‚úÖ Field sizes ber√§knas OK
5. ‚úÖ B√∂rjar processa batchar
6. ‚úÖ F√∂rbereder bulk INSERT med 50 rader
7. ‚ùå INSERT IGNORE query H√ÑNGER och tar aldrig slut

DEBUG OUTPUT
------------
üíæ Processing results in batches...
üîß Inserting batch of 50 rows...
[STANNAR H√ÑR - INGEN OUTPUT EFTER DETTA]

AKTUELL BULK INSERT QUERY
--------------------------
INSERT IGNORE INTO ranking_points (
    rider_id, event_id, class_id, discipline,
    original_points, field_size, field_multiplier,
    event_level_multiplier, ranking_points, event_date
) VALUES
    (?, ?, ?, ?, ?, ?, ?, ?, ?, ?),
    (?, ?, ?, ?, ?, ?, ?, ?, ?, ?),
    ... (50 rader totalt, 500 parametrar)

KOD SOM H√ÑNGER (ranking_functions.php rad 422-428)
---------------------------------------------------
$valuesStr = implode(', ', $insertValues);
$db->query("
    INSERT IGNORE INTO ranking_points (
        rider_id, event_id, class_id, discipline,
        original_points, field_size, field_multiplier,
        event_level_multiplier, ranking_points, event_date
    ) VALUES {$valuesStr}
", $insertParams);


VAD SOM PROVATS (UTAN FRAMG√ÖNG)
================================================================================

F√ñRS√ñK 1: DELETE FROM ranking_points WHERE event_date >= ?
----------------------------------------------------------
Resultat: H√ÑNGER
Orsak: √Ñven p√• tom tabell (0 rader) h√§nger DELETE-queryn

F√ñRS√ñK 2: TRUNCATE TABLE ranking_points
----------------------------------------
Resultat: H√ÑNGER
Orsak: Foreign key constraints blockerar TRUNCATE

F√ñRS√ñK 3: TRUNCATE med SET FOREIGN_KEY_CHECKS = 0
--------------------------------------------------
Resultat: H√ÑNGER FORTFARANDE
Orsak: Oklart varf√∂r, borde fungera

F√ñRS√ñK 4: REPLACE INTO (en rad √•t g√•ngen)
------------------------------------------
Resultat: Duplicate key error
Orsak: REPLACE INTO kastar fortfarande constraint violation

F√ñRS√ñK 5: INSERT ... ON DUPLICATE KEY UPDATE (en rad)
------------------------------------------------------
Resultat: H√ÑNGER
Orsak: L√•ngsam med alla index och foreign keys

F√ñRS√ñK 6: INSERT IGNORE (en rad √•t g√•ngen)
-------------------------------------------
Resultat: H√ÑNGER p√• f√∂rsta INSERT
Orsak: Varje INSERT m√•ste validera mot alla index + foreign keys

F√ñRS√ñK 7: Bulk INSERT IGNORE (50 rader √•t g√•ngen) - NUVARANDE
--------------------------------------------------------------
Resultat: H√ÑNGER p√• f√∂rsta bulk INSERT
Orsak: 50 rader √ó (5 index + 3 FK) = f√∂r tungt

Query som k√∂rs:
- 50 rader samtidigt
- 10 kolumner per rad
- 500 parametrar totalt
- 5 index som m√•ste uppdateras
- 3 foreign keys som m√•ste valideras


M√ñJLIGA ORSAKER
================================================================================

1. INDEX OVERHEAD
   - 5 index per INSERT-rad √§r tungt
   - PRIMARY KEY (id)
   - UNIQUE (rider_id, event_id, class_id)
   - INDEX (rider_id)
   - INDEX (event_date)
   - INDEX (event_id, class_id)
   - INDEX (discipline)

2. FOREIGN KEY VALIDATION
   - 3 foreign keys m√•ste valideras per rad
   - ON DELETE CASCADE g√∂r dem √§nnu tyngre
   - Kanske sker table locks under validation

3. MYSQL TIMEOUT SETTINGS
   - wait_timeout (ok√§nd - troligen default 28800s)
   - lock_wait_timeout (ok√§nd - troligen default 50s)
   - innodb_lock_wait_timeout (ok√§nd - troligen default 50s)

   PHP timeout: 300s (5 minuter)
   Men MySQL kan ha kortare timeouts

4. TABLE LOCKS
   - SHOW OPEN TABLES visade inga locks
   - Men kanske uppst√•r lock under INSERT
   - InnoDB row-level locks kan blockera

5. QUERY BUFFER/PARAMETER LIMIT
   - 500 parametrar kan vara f√∂r m√•nga f√∂r prepared statement
   - MySQL max_allowed_packet kanske √§r f√∂r liten


TESTFILER SKAPADE
================================================================================

/admin/ranking-minimal.php
--------------------------
Minimal test av ranking-ber√§kning
- Laddar endast n√∂dv√§ndiga filer
- K√∂r calculateAllRankingPoints($db, true) med debug
- Visar progress steg f√∂r steg
- Try-catch f√∂r errors

ANV√ÑNDNING: /admin/ranking-minimal.php ‚Üí klicka "Run Calculation"


/admin/check-ranking-tables.php
--------------------------------
Kontrollerar databas-status
- Kollar att tabeller existerar
- R√§knar antal rader i varje tabell
- Kollar att funktioner √§r laddade
- Visar senaste migrations

ANV√ÑNDNING: /admin/check-ranking-tables.php


/admin/test-delete.php
----------------------
Testar DELETE-query isolerat
- R√§knar rader f√∂re DELETE
- K√∂r DELETE FROM ranking_points WHERE event_date >= ?
- R√§knar rader efter DELETE
- M√§ter tid

RESULTAT: DELETE h√§nger √§ven p√• tom tabell


/admin/test-table-structure.php
--------------------------------
Visar detaljerad table-info
- SHOW CREATE TABLE ranking_points
- SHOW OPEN TABLES (locks)
- SHOW PROCESSLIST (active queries)
- SHOW TABLE STATUS
- F√∂rs√∂k med DELETE LIMIT 1000

RESULTAT: DELETE LIMIT h√§nger ocks√•


N√ÑSTA STEG ATT PROVA
================================================================================

KORTSIKTIGA FIXES (TEST)
-------------------------

1. MINSKA BATCH SIZE
   √Ñndra fr√•n 50 till 5 eller 10 rader per INSERT
   Plats: ranking_functions.php rad 338
   $batchSize = 50; ‚Üí $batchSize = 5;

2. DISABLE INDEX UNDER INSERT
   ALTER TABLE ranking_points DISABLE KEYS;
   ... INSERT queries ...
   ALTER TABLE ranking_points ENABLE KEYS;

   OBS: Fungerar bara f√∂r MyISAM, inte InnoDB

3. TESTA INSERT DIREKT I MYSQL
   Logga in p√• MySQL och k√∂r:

   INSERT IGNORE INTO ranking_points (
       rider_id, event_id, class_id, discipline,
       original_points, field_size, field_multiplier,
       event_level_multiplier, ranking_points, event_date
   ) VALUES (1, 1, 1, 'ENDURO', 100, 10, 0.95, 1.0, 95, '2024-11-01');

   Om detta h√§nger √§r det databas-problem, inte PHP

4. KOLLA MYSQL PROCESSLIST MEDAN DEN H√ÑNGER
   SHOW FULL PROCESSLIST;

   Se om INSERT k√∂rs, v√§ntar p√• lock, eller n√•got annat

5. √ñKA MYSQL TIMEOUTS
   SET GLOBAL wait_timeout = 28800;
   SET GLOBAL lock_wait_timeout = 300;
   SET GLOBAL innodb_lock_wait_timeout = 300;

6. KOLLA MYSQL SLOW QUERY LOG
   SET GLOBAL slow_query_log = 'ON';
   SET GLOBAL long_query_time = 2;

   Kolla /var/log/mysql/slow.log


L√ÖNGSIKTIGA L√ñSNINGAR
----------------------

1. HELT ANNAN APPROACH: VIEW IST√ÑLLET F√ñR INSERT
   Skapa en VIEW som ber√§knar ranking on-the-fly:

   CREATE VIEW ranking_view AS
   SELECT
       r.cyclist_id as rider_id,
       r.event_id,
       r.class_id,
       e.discipline,
       r.points as original_points,
       (field size ber√§kning) as field_size,
       (field multiplier ber√§kning) as field_multiplier,
       (event level ber√§kning) as event_level_multiplier,
       (slutlig ber√§kning) as ranking_points,
       e.date as event_date
   FROM results r
   JOIN events e ON r.event_id = e.id
   WHERE ...

   F√ñRDELAR:
   - Ingen INSERT beh√∂vs
   - Alltid uppdaterad data
   - Inga locks

   NACKDELAR:
   - L√•ngsam query vid m√•nga resultat
   - Sv√•rare att optimera

2. TA BORT FOREIGN KEYS
   ALTER TABLE ranking_points DROP FOREIGN KEY ranking_points_ibfk_1;
   ALTER TABLE ranking_points DROP FOREIGN KEY ranking_points_ibfk_2;
   ALTER TABLE ranking_points DROP FOREIGN KEY ranking_points_ibfk_3;

   RISK: Dataintegrity f√∂rloras

3. TA BORT EXTRA INDEX
   Beh√•ller endast PRIMARY och UNIQUE:

   ALTER TABLE ranking_points DROP INDEX idx_rider;
   ALTER TABLE ranking_points DROP INDEX idx_event_date;
   ALTER TABLE ranking_points DROP INDEX idx_event_class;
   ALTER TABLE ranking_points DROP INDEX idx_discipline;

   L√§gg till dem EFTER att INSERT √§r klart

4. ANV√ÑND LOAD DATA INFILE
   Skriv data till CSV-fil, sedan:

   LOAD DATA INFILE '/tmp/ranking.csv'
   INTO TABLE ranking_points
   FIELDS TERMINATED BY ','
   IGNORE 1 LINES;

   Mycket snabbare √§n INSERT


DIAGNOSTISKA KOMMANDON
================================================================================

KOLLA AKTUELL DATABASE STATUS
------------------------------
SHOW FULL PROCESSLIST;
SHOW OPEN TABLES WHERE In_use > 0;
SHOW TABLE STATUS LIKE 'ranking_points';
SELECT COUNT(*) FROM ranking_points;

KOLLA LOCKS
-----------
SELECT * FROM information_schema.INNODB_LOCKS;
SELECT * FROM information_schema.INNODB_LOCK_WAITS;
SELECT * FROM information_schema.INNODB_TRX;

KOLLA MYSQL VARIABLER
----------------------
SHOW VARIABLES LIKE 'wait_timeout';
SHOW VARIABLES LIKE 'lock_wait_timeout';
SHOW VARIABLES LIKE 'innodb_lock_wait_timeout';
SHOW VARIABLES LIKE 'max_allowed_packet';

KOLLA TABLE SIZE
----------------
SELECT
    table_name,
    round(((data_length + index_length) / 1024 / 1024), 2) as size_mb,
    table_rows
FROM information_schema.TABLES
WHERE table_schema = 'thehub_db'
AND table_name = 'ranking_points';


FILER ATT GRANSKA
================================================================================

HUVUDFILER
----------
/home/user/TheHUB/includes/ranking_functions.php
  - Rad 241-445: calculateAllRankingPoints() funktionen
  - Rad 342-434: Bulk INSERT loop (H√ÑNGER H√ÑR)
  - Rad 422-428: Sj√§lva INSERT IGNORE query

/home/user/TheHUB/database/migrations/028_ranking_system.sql
  - Rad 19-42: CREATE TABLE ranking_points

/home/user/TheHUB/database/migrations/030_fix_ranking_points_columns.sql
  - ALTER TABLE ADD COLUMN discipline
  - ALTER TABLE ADD COLUMN event_level_multiplier

TESTFILER
---------
/home/user/TheHUB/admin/ranking-minimal.php
/home/user/TheHUB/admin/check-ranking-tables.php
/home/user/TheHUB/admin/test-delete.php
/home/user/TheHUB/admin/test-table-structure.php

LOGGAR
------
MySQL slow query log (om aktiverad)
MySQL error log
PHP error log


KONTAKTINFORMATION
================================================================================

System: TheHUB - Gravity Series ranking system
Server: Hostinger shared hosting
Database: MySQL/MariaDB (version ok√§nd)
PHP Version: Ok√§nd (troligen 7.4+)

Anv√§ndare som implementerat: Claude Code AI
Datum: 2025-11-24

Problemrapport skapad f√∂r extern fels√∂kning.


SAMMANFATTNING
================================================================================

K√ÑRNPROBLEMET:
INSERT IGNORE INTO ranking_points h√§nger p√• f√∂rsta bulk insert (50 rader)

TROLIG ORSAK:
Kombinationen av 5 index + 3 foreign keys + bulk insert √§r f√∂r tung f√∂r
shared hosting MySQL server

REKOMMENDERAD FIX:
1. Testa minska batch size fr√•n 50 till 5
2. Om det inte hj√§lper, ta bort foreign keys tempor√§rt
3. Om det inte hj√§lper, ta bort extra index tempor√§rt
4. Om det inte hj√§lper, anv√§nd LOAD DATA INFILE eller VIEW-approach

SNABBTEST:
K√∂r INSERT direkt i MySQL console f√∂r att se om det √§r kod eller databas

================================================================================
SLUT P√Ö DOKUMENTATION
================================================================================
