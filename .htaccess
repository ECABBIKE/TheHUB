# TheHUB Security Configuration

# Deny access to .env files
<FilesMatch "^\.env">
    Order allow,deny
    Deny from all
</FilesMatch>

# Deny access to git files
<FilesMatch "^\.git">
    Order allow,deny
    Deny from all
</FilesMatch>

# Deny access to composer files
<FilesMatch "composer\.(json|lock)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Deny access to package manager files
<FilesMatch "(package\.json|package-lock\.json|yarn\.lock)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Enable rewrite engine
RewriteEngine On
RewriteBase /

# Redirect to HTTPS (enabled for production)
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Prevent directory listing
Options -Indexes

# ============================================================================
# V3 SPA ROUTING - All requests go through index.php
# ============================================================================

# Skip rewriting for actual files (CSS, JS, images, etc.)
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# ============================================================================
# Force SPA routing for V3 sections (override physical directories)
# These URLs should go to the SPA router even if matching directories exist
# ============================================================================

# Auth pages
RewriteRule ^login/?$ index.php?page=login [QSA,L]
RewriteRule ^logout/?$ index.php?page=logout [QSA,L]
RewriteRule ^dashboard/?$ index.php?page=dashboard [QSA,L]
RewriteRule ^welcome/?$ index.php?page=welcome [QSA,L]

# Main sections
RewriteRule ^database(/.*)?$ index.php?page=database$1 [QSA,L]
RewriteRule ^ranking(/.*)?$ index.php?page=ranking$1 [QSA,L]
RewriteRule ^calendar(/.*)?$ index.php?page=calendar$1 [QSA,L]
RewriteRule ^results(/.*)?$ index.php?page=results$1 [QSA,L]
RewriteRule ^series(/.*)?$ index.php?page=series$1 [QSA,L]
RewriteRule ^profile(/.*)?$ index.php?page=profile$1 [QSA,L]
RewriteRule ^rider(/.*)?$ index.php?page=rider$1 [QSA,L]
RewriteRule ^club(/.*)?$ index.php?page=club$1 [QSA,L]
RewriteRule ^event(/.*)?$ index.php?page=event$1 [QSA,L]
RewriteRule ^riders/?$ index.php?page=riders [QSA,L]
RewriteRule ^clubs/?$ index.php?page=clubs [QSA,L]

# Skip admin folder - let it handle its own routing
RewriteRule ^admin(/.*)?$ - [L]

# Skip API endpoints (direct PHP files)
RewriteRule ^api/.*\.php$ - [L]

# Skip v2 backup folder
RewriteRule ^v2(/.*)?$ - [L]

# Skip legacy .php files for backwards compatibility
RewriteCond %{REQUEST_URI} \.(php)$
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# ============================================================================
# Route everything else to V3 SPA index.php
# ============================================================================
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php?page=$1 [QSA,L]

# ============================================================================
# Cache static assets
# ============================================================================
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
</IfModule>

# Gzip compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/css application/javascript application/json
</IfModule>

# Security headers
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
</IfModule>

# Custom error pages
ErrorDocument 404 /index.php?page=404
